$(function () {
    var e = $("input[name=keyword]"), a = $(".layer"), r = $(".find_brand"), n = $(".cancel"), i = ($(".search form"), $(".cate_body >div"), $(".brand_body > div"), 5), s = function (e, a) {
        var r = /[-[\]{}()+?.,\\^$|#\s]/g, n = a.replace(r, "\\$&"), i = new RegExp(n, "ig");
        return e = e.replace(i, function (e) {
            return "<span>" + e + "</span>"
        })
    }, c = function (e, a) {
        var r, n = "";
        return $(e).each(function (e, i) {
            if (!i.parent_id && i.initial)r = ['<div class="search_layer border_1px">', '<div class="search_item" data-href="/products?where[brand_id]=', i.id, '"><p class="brand_name ellipsis">', s(i.name, a), '</p><div class="down_shadow"></div></div>', "</div>"], n += r.join(""); else {
                var c = "category1_id";
                1 != i.parent_id && (c = "category2_id"), r = ['<div class="search_layer border_1px">', '<div class="search_item" data-href="/products?where[', c, "]=", i.id, '"><p class="category_name ellipsis">', s(i.name, a), '</p><div class="down_shadow"></div></div>', "</div>"], n += r.join("")
            }
        }), n
    }, t = function (e) {
        e || (e = i);
        for (var a = [], r = 0; e > r; r++)a.push({id: null, name: "", chinese: ""});
        return a
    }, d = function (e) {
        $(e).bind("click touchstart itap", function () {
            app.iscroll.disable()
        })
    }, l = function (e, a) {
        var n = "keyword=" + e;
        $.getJSON("/search.json?" + n, function (n) {
            var i = [];
            if (null != n.category_search && n.category_search.length > 0) {
                var s = 5;
                n.category_search.length < 5 && (s = n.category_search.length), i = c(n.category_search.concat(t()).slice(0, s), e)
            }
            if (null != n.brands_search && n.brands_search.length > 0) {
                var s = 5;
                n.brands_search.length < 5 && (s = n.brands_search.length), i += c(n.brands_search.concat(t()).slice(0, s), e)
            }
            r.html(i), $(".layer.find_brand").css("max-height", DeviceInfo.height - 110), d($(".search_layer > div")), app.push_event($(".search_layer > div"), 100), a && a()
        })
    };
    e.bind("input", function () {
        var a = e.val();
        //l(a),
        n.toggleClass("hide", 0 == a.length)
    }).focus(function () {
        a.removeClass("hide"), e.trigger("input"), n.toggleClass("hide", 0 == e.val().length)
    }).blur(function () {
        n.addClass("hide"), setTimeout(function () {
            a.addClass("hide")
        }, 100)
    })
});
