<% data = case params[:department]
	when 'market'
		[%w[ID 状态 成交价 帐号点击来源 帐号点击时间 帐号创建时间 交易点击来源 交易点击时间 交易创建时间]] + @trades.map { |trade| account=trade.user_id && Core::Account.acquire(trade.user_id);[trade.id, Shop::Trade::STATUS[trade.status],  trade.price, account && account.link && account.link.ad && account.link.ad.promotion && account.link.ad.promotion.name, account && account.click && account.click.created_at.to_s(:db), account && account.created_at && account.created_at.to_s(:db), trade.link && trade.link.ad && trade.link.ad.promotion && trade.link.ad.promotion.name, trade.click && trade.click.created_at.to_s(:db), trade.created_at && trade.created_at.to_s(:db) ] }
	when 'finance'
		[%w[单品ID 编号 产品ID 商品名 品牌 一级分类 二级分类 悦购价 购买价格 购买者ID 订单ID 订单号 订单状态 订单创建时间 订单审核时间 商品发货时间 付款方式 邮寄方式 物流单号 收款金额 收款编辑 收款时间 是否退货 退货时间 签收日期 退换备注 收货人名称 联系方式 收货地址 邮编 发票类型 发票抬头 发票内容 快递时间 用户留言 备注]] + @trades.map { |trade| trade.units.map {|unit| [unit.item_id, unit.item && "\t#{unit.item.identifer}", unit.item && unit.item.product_id, unit.item && unit.item.product && unit.item.product.name, unit.item && unit.item.product && unit.item.product.brand && unit.item.product.brand.name, unit.item && unit.item.product && unit.item.product.category1 && unit.item.product.category1.name, unit.item && unit.item.product && unit.item.product.category2 && unit.item.product.category2.name, unit.discount, unit.price, @current_user.can_show_contact? ? trade.user_id : nil, trade.id, "\t#{trade.identifier}", Shop::Trade::STATUS[trade.status], trade.created_at&&trade.created_at.to_s(:db), trade.audit_at && trade.audit_at.to_s(:db), trade.ship_at&&trade.ship_at.to_s(:db), trade.payment_service && Shop::Trade::PAYMENT_SERVICES[trade.payment_service], (ps = Shop::Trade.delivery_coms_arr.find{|d| d[:name] == trade.delivery_service }) && ps[:title], "\t#{trade.delivery_identifier}", unit.price, trade.receipt_editor && trade.receipt_editor.name, trade.receipted_at && trade.receipted_at.to_s(:db), unit.status ? '是' : '否', unit.request_at && unit.request_at.to_s(:db),'', unit.remark, @current_user.can_show_contact? ? trade.contact && trade.contact.name : nil, @current_user.can_show_contact? ? trade.contact && "#{trade.contact.mobile} #{trade.contact.phone}" : nil, @current_user.can_show_contact? ? trade.contact && %[#{trade.contact.province} #{trade.contact.city} #{trade.contact.town} #{trade.contact.address}] : nil, @current_user.can_show_contact? ? trade.contact && trade.contact.postcode : nil, @current_user.can_show_contact? ? Shop::Trade::INVOICE_TYPES[trade.invoice_type] : nil, @current_user.can_show_contact? ? trade.invoice_title : nil, @current_user.can_show_contact? ? Shop::Trade::INVOICE_CONTENTS[trade.invoice_content] : nil, nil, trade.comment, trade.remark] }}.inject(&:+)
	when 'business'
		[%w[序号 订单状态 订单日期 收货人名称 联系方式 收货地址 邮编 商品编号 商品名称 订单号 商户订单号 付款金额 支付方式 财务确认 是否已收款 收款时间 发货时间 快递单号 签收日期 退换备注 发票类型 发票抬头 发票内容 快递时间 用户留言 备注]] + @trades.map { |trade| [nil, Shop::Trade::STATUS[trade.status], trade.created_at.to_s(:db), @current_user.can_show_contact? ? trade.contact && trade.contact.name : nil, @current_user.can_show_contact? ? trade.contact && "#{trade.contact.mobile} #{trade.contact.phone}" : nil, @current_user.can_show_contact? ? trade.contact && %[#{trade.contact.province} #{trade.contact.city} #{trade.contact.town} #{trade.contact.address}] : nil, @current_user.can_show_contact? ? trade.contact && trade.contact.postcode : nil, trade.units.map{|u| "\t#{u.item.identifer}"}.join("\n"), trade.units.map{|u|u.item.product.name}.join("\n"), "\t#{trade.identifier}", trade.id, trade.price, Shop::Trade::PAYMENT_SERVICES[trade.payment_service], nil, (trade.receipted_at? ? '是' : ''), trade.receipted_at && trade.receipted_at.to_s(:db), nil, trade.delivery_identifier, nil, nil, @current_user.can_show_contact? ? Shop::Trade::INVOICE_TYPES[trade.invoice_type] : nil, @current_user.can_show_contact? ? trade.invoice_title : nil, @current_user.can_show_contact? ? Shop::Trade::INVOICE_CONTENTS[trade.invoice_content] : nil , nil, trade.comment, trade.remark] }
	when 'invoice'
		[%w[序号 订单状态 订单ID 订单日期 商品收件人名称 商品编号 商品名称 付款金额 发票类型 发票抬头 发票内容 发票备注 用户留言 备注 发票收件人名称 发票收件人地址 发票收件人手机 发票地址邮编 商品收件人地址 商品收件人手机 商品地址邮编]]+ @trades.map{ |trade| [nil, Shop::Trade::STATUS[trade.status], trade.id, trade.created_at.to_s(:db), @current_user.can_show_contact? ? trade.contact && trade.contact.name : nil, trade.units.map{|u| "\t#{u.item.identifer}"}.join("\n"), trade.units.map{|u|u.item.product.name}.join("\n"), trade.payment_price, @current_user.can_show_contact? ? Shop::Trade::INVOICE_TYPES[trade.invoice_type] : nil, @current_user.can_show_contact? ? trade.invoice_title : nil, @current_user.can_show_contact? ? Shop::Trade::INVOICE_CONTENTS[trade.invoice_content] : nil, trade.invoice_remark , trade.comment, trade.remark,  @current_user.can_show_contact? ? trade.invoice_contact && trade.invoice_contact.name : nil, @current_user.can_show_contact? ? trade.invoice_contact && %[#{trade.invoice_contact.province} #{trade.invoice_contact.city} #{trade.invoice_contact.town} #{trade.invoice_contact.address}] : nil, @current_user.can_show_contact? ? trade.invoice_contact && "#{trade.invoice_contact.mobile}" : nil, @current_user.can_show_contact? ? trade.invoice_contact && "#{trade.invoice_contact.postcode}" : nil, @current_user.can_show_contact? ? trade.contact && %[#{trade.contact.province} #{trade.contact.city} #{trade.contact.town} #{trade.contact.address}] : nil, @current_user.can_show_contact? ? trade.contact && "#{trade.contact.mobile}" : nil, @current_user.can_show_contact? ? trade.contact && "#{trade.contact.postcode}" : nil ]}
	end || [] %><%= raw "\357\273\277#{data.map(&:to_csv).join}" -%>
